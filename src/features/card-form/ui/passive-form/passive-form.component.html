<div class="flex flex-col gap-6" [formGroupName]="controlKey()">
    <!-- Passive Name -->
    <div class="flex flex-col gap-2">
        <label class="text-sm font-semibold text-gray-400 uppercase" for="passiveName">Passive Skill Name</label>
        <input placeholder="e.g. Warrior's Resolve"
            class="w-full bg-gray-800 border border-gray-600 rounded p-3 text-white focus:outline-none focus:border-orange-500 transition-colors"
            id="passiveName" formControlName="passiveName" type="text">
    </div>

    <!-- Passive Parts List -->
    <div class="flex flex-col gap-4" formArrayName="passivePart">
        @for (control of this.passiveParts.controls; track control.value; let index = $index) {
        <div class="p-4 bg-gray-900/50 rounded border border-gray-700" [formGroupName]="index">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h4 class="text-gray-300 font-bold">Passive Part #{{index + 1}}</h4>
                @if (index !== 0) {
                <button type="button" class="text-red-400 hover:text-red-300 text-sm uppercase font-bold"
                    (click)="removePassivePart(index)">
                    Remove Part
                </button>
                }
            </div>

            <!-- Condition -->
            <div class="flex flex-col gap-2 mb-4">
                <label class="text-sm font-semibold text-gray-400 uppercase">Activation Condition</label>
                <ng-select (change)="onOptionChange($event, index)" class="custom-select" [searchable]="false"
                    [clearable]="false" formControlName="passiveConditionActivation">
                    <ng-option value="custom">--- Custom condition ---</ng-option>
                    @for (condition of passiveConditionActivation(); track $index) {
                    <ng-option [value]="condition.value">{{condition.effect}}</ng-option>
                    }
                </ng-select>

                @if (isCustomConditionSelected(index)) {
                <input placeholder="e.g. When HP is 50% or less"
                    class="w-full bg-gray-800 border border-gray-600 rounded p-3 text-white focus:outline-none focus:border-orange-500 transition-colors mt-2"
                    formControlName="customPassiveConditionActivation" type="text">
                }
            </div>

            <!-- Effects -->
            <div class="flex flex-col gap-3" formArrayName="effect">
                <label class="text-sm font-semibold text-gray-400 uppercase">Effects</label>
                @for (control of getPassiveEffects(index).controls; track $index; let index2 = $index) {
                <div [formGroupName]="index2" class="flex flex-col sm:flex-row gap-2 items-start">
                    <div class="w-full sm:w-auto flex-1 flex flex-col gap-1">
                        <input
                            class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white focus:outline-none focus:border-orange-500 transition-colors"
                            formControlName="effectDescription" placeholder="e.g. ATK & DEF +150%" />
                        @if (getPassiveEffects(index).controls[index2].get('effectDescription')?.dirty &&
                        getPassiveEffects(index).controls[index2].get('effectDescription')?.getError('required')) {
                        <app-error errorMessage="Effect description is required" />
                        }
                    </div>

                    <div class="w-full sm:w-24">
                        <ng-select [clearable]="false" [searchable]="false" class="custom-select small-select"
                            formControlName="effectDuration">
                            @for (duration of effectDuration() ; track $index) {
                            <ng-option [value]="duration.value">
                                @if (duration.icon === "None") {
                                None
                                } @else {
                                <img [src]="duration.icon" alt="" class="w-6 h-6 object-contain inline-block">
                                }
                            </ng-option>
                            }
                        </ng-select>
                    </div>

                    <button type="button"
                        class="p-2 bg-red-900/30 border border-red-900/50 rounded hover:bg-red-900/50 text-red-400 transition-colors h-[42px] w-[42px] flex items-center justify-center mt-1"
                        [disabled]=" index2===0" [class.opacity-50]="index2 === 0"
                        [class.cursor-not-allowed]="index2 === 0" (click)="removePassiveEffect(index, index2)">
                        <ng-icon name="heroArchiveBoxXMark" class="h-5 w-5" />
                    </button>
                </div>
                }

                <button type="button"
                    class="mt-2 py-2 px-4 bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded text-sm text-gray-300 w-full md:w-auto self-start transition-colors"
                    (click)="addPassiveEffect(index)">
                    + Add Effect
                </button>
            </div>
        </div>
        }

        <button type="button"
            class="py-3 px-6 bg-green-900/40 hover:bg-green-900/60 border border-green-700/50 rounded text-green-400 font-bold uppercase tracking-wider w-full transition-colors"
            (click)="addPassivePart()">
            + Add New Passive Condition Part
        </button>
    </div>
</div>